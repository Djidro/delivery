<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodExpress MVP - Talabat Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_KEY"></script>
    <style>
        .screen { display: none; min-height: 100vh; padding: 20px; }
        .active { display: block; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 15px; }
        #map { height: 300px; width: 100%; border-radius: 12px; margin-top: 15px; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app">
        <section id="screen-auth" class="screen active text-center">
            <h1 class="text-3xl font-bold text-red-500 my-10">FoodExpress</h1>
            <button onclick="showScreen('customer')" class="w-full bg-red-500 text-white p-4 rounded-lg mb-4">I am a Customer</button>
            <button onclick="showScreen('restaurant')" class="w-full bg-gray-800 text-white p-4 rounded-lg mb-4">I am a Restaurant</button>
            <button onclick="showScreen('driver')" class="w-full bg-blue-600 text-white p-4 rounded-lg">I am a Driver</button>
        </section>

        <section id="screen-customer" class="screen">
            <h2 class="text-xl font-bold mb-4">Select Items</h2>
            <div id="menu-items" class="card">
                <p>Pizza Margherita - $12</p>
                <button onclick="placeOrder('Pizza Margherita', 12)" class="bg-red-500 text-white px-4 py-2 rounded mt-2">Order Now</button>
            </div>
            <div id="customer-status" class="hidden">
                <div class="card bg-orange-100">
                    <h3 class="font-bold">Order Tracking</h3>
                    <p id="track-status" class="text-2xl text-orange-600">Waiting...</p>
                </div>
                <div id="map"></div>
            </div>
        </section>

        <section id="screen-restaurant" class="screen">
            <h2 class="text-xl font-bold mb-4">Kitchen Orders</h2>
            <div id="order-list-restaurant"></div>
        </section>

        <section id="screen-driver" class="screen">
            <h2 class="text-xl font-bold mb-4">Delivery Tasks</h2>
            <div id="order-list-driver"></div>
        </section>
    </div>

    <script type="module">
        import { db } from './firebase-config.js';
        import { collection, addDoc, onSnapshot, doc, updateDoc, query, where, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let map, marker;
        const currentOrderId = "LIVE_ORDER_SESSION"; // Simplified for MVP

        window.showScreen = (role) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`screen-${role}`).classList.add('active');
            if(role === 'restaurant') initRestaurant();
            if(role === 'driver') initDriver();
        };

        // --- CUSTOMER LOGIC ---
        window.placeOrder = async (name, price) => {
            const docRef = await addDoc(collection(db, "orders"), {
                itemName: name,
                status: "pending",
                lat: 23.5880, lng: 58.3829, // Default start coord
                createdAt: serverTimestamp()
            });
            document.getElementById('customer-status').classList.remove('hidden');
            listenToOrder(docRef.id);
        };

        function listenToOrder(id) {
            onSnapshot(doc(db, "orders", id), (snapshot) => {
                const data = snapshot.data();
                document.getElementById('track-status').innerText = data.status.toUpperCase();
                updateMap(data.lat, data.lng);
            });
        }

        function updateMap(lat, lng) {
            const pos = { lat, lng };
            if (!map) {
                map = new google.maps.Map(document.getElementById("map"), { zoom: 15, center: pos });
                marker = new google.maps.Marker({ position: pos, map: map, title: "Driver" });
            } else {
                marker.setPosition(pos);
                map.panTo(pos);
            }
        }

        // --- RESTAURANT LOGIC ---
        function initRestaurant() {
            onSnapshot(query(collection(db, "orders"), where("status", "==", "pending")), (snap) => {
                const container = document.getElementById('order-list-restaurant');
                container.innerHTML = "";
                snap.forEach(d => {
                    container.innerHTML += `
                        <div class="card">
                            <p><b>Order:</b> ${d.data().itemName}</p>
                            <button onclick="updateStatus('${d.id}', 'preparing')" class="bg-green-500 text-white p-2 rounded">Accept Order</button>
                            <button onclick="updateStatus('${d.id}', 'ready')" class="bg-blue-500 text-white p-2 rounded ml-2">Ready for Pickup</button>
                        </div>`;
                });
            });
        }

        // --- DRIVER LOGIC ---
        function initDriver() {
            onSnapshot(query(collection(db, "orders"), where("status", "==", "ready")), (snap) => {
                const container = document.getElementById('order-list-driver');
                container.innerHTML = "";
                snap.forEach(d => {
                    container.innerHTML += `
                        <div class="card">
                            <p>Pickup: ${d.data().itemName}</p>
                            <button onclick="simulateDelivery('${d.id}')" class="bg-blue-600 text-white p-2 rounded">Start Delivery Simulation</button>
                        </div>`;
                });
            });
        }

        window.updateStatus = async (id, status) => {
            await updateDoc(doc(db, "orders", id), { status });
        };

        window.simulateDelivery = (id) => {
            let lat = 23.5880;
            let lng = 58.3829;
            setInterval(async () => {
                lat += 0.0002;
                lng += 0.0002;
                await updateDoc(doc(db, "orders", id), { lat, lng, status: "On the way" });
            }, 3000);
        };

        // Export to window for HTML buttons
        window.updateStatus = updateStatus;
        window.simulateDelivery = simulateDelivery;
    </script>
</body>
</html>
